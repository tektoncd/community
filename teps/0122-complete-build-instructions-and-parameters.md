---
status: proposed
title: Complete Build Instructions and Parameters
creation-date: '2022-09-14'
last-updated: '2022-11-29'
authors:
- '@chitrangpatel'
see-also:
---

# TEP-0122: Complete Build Instructions and Parameters

<!-- toc -->
- [Summary](#summary)
- [Motivation](#motivation)
- [Requirements](#requirements)
- [Goals](#goals)
- [Out-of-scope](#out-of-scope)
- [Proposal](#proposal)
  - [Task Specification](#task-specification)
  - [Step Specification](#step-specification)
  - [TaskRef](#taskref)
  - [TaskRun Specification](#taskrun-specification)
  - [Configuration Feature Flags](#configuration-feature-flags)
  - [Materials](#materials)
  - [Provenance for executed TaskRun](#provenance-for-executed-taskrun)
<!-- /toc -->

## Summary
This proposal outlines what information is required in the [provenance](#provenance-for-executed-taskrun) for complete build instructions and parameters for taskruns. It also suggests where in the `SLSA v0.2` [provenance](https://slsa.dev/provenance/v0.2) to store this information. 
 
## Motivation

[Tekton Chains will report provenance as reproducible if a specific annotation is included in the TaskRun](https://docs.google.com/document/d/12yYP0M_zz5Tc9ftGnLwhDZ_tdZBq4mEod70ngWtHmLs/edit#bookmark=id.1sm6isih1d0n) and it includes Task steps and parameter values in the provenance it generates, however there is a great deal of Task spec contents it ignores (e.g. sidecar definitions) and runtime information it does not include (e.g. workspaces provided at runtime). 

For example the following provenance snippet was generated by Tekton Chains ([v0.8.0](https://github.com/tektoncd/chains/releases/tag/v0.8.0)) from [this chains example Task](https://github.com/tektoncd/chains/blob/main/examples/kaniko/kaniko.yaml) - it contains step information (including the shas of the images run) but is missing other information such as the workspaces and the volumes that backed them:

```yaml
invocation:
  configSource: {}
  parameters:
    BUILDER_IMAGE: gcr.io/kaniko-project/executor:v1.5.1@sha256:c6166717f7fe0b7da44908c986137ecfeab21f31ec3992f6e128fff8a94be8a5
    CONTEXT: ./
    DOCKERFILE: ./Dockerfile
    EXTRA_ARGS: '[]'
    IMAGE: '{string us.gcr.io/christiewilson-catfactory/kaniko-chains []}'
buildConfig:
  steps:
    - entryPoint: |
        set -e
        echo "FROM alpine@sha256:69e70a79f2d41ab5d637de98c1e0b055206ba40a8145e7bddb55ccc04e13cf8f" | tee $(params.DOCKERFILE)
      arguments: null
      environment:
        container: add-dockerfile
        image: docker-pullable://bash@sha256:fc742d0c3d9d8f5fb2681062398c04b710cd08c46dac1a8f0a5515687018acb9
      annotations: null
    - entryPoint: ""
      arguments:
        - $(params.EXTRA_ARGS)
        - --dockerfile=$(params.DOCKERFILE)
        - --context=$(workspaces.source.path)/$(params.CONTEXT)
        - --destination=$(params.IMAGE)
        - --digest-file=$(results.IMAGE_DIGEST.path)
      environment:
        container: build-and-push
        image: docker-pullable://gcr.io/kaniko-project/executor@sha256:68bb272f681f691254acfbdcef00962f22efe2f0c1e287e6a837b0abe07fb94b
      annotations: null
    - entryPoint: |
        set -e
        echo $(params.IMAGE) | tee $(results.IMAGE_URL.path)
      arguments: null
      environment:
        container: write-url
        image: docker-pullable://bash@sha256:fc742d0c3d9d8f5fb2681062398c04b710cd08c46dac1a8f0a5515687018acb9
      annotations: null
```

## Requirements
- For completeness of build instructions, the provenance should contain all of the Task definition and runtime information.
- The shas of the images run should continue to be included regardless (as this is part of the dependencies / build instructions)
- It must be possible for users to construct policies based on the provenance that would allow them to determine if the build is ok - for example if they have policies around what pipeline tasks are acceptable to use, what parameters are acceptable, whether or not sidecars are allowed etc.
  - According to [SLSA v0.2](https://slsa.dev/provenance/v0.2), if **invocation.configSource** is not available then **buildConfig** can be used to verify information about the build. If the policy requires validating the underlying task/pipeline spec that was not fetched from version control then the information from the spec required for validation must be embedded in the provenance’s buildConfig. 

## Goals
This proposal attempts to do the following:

- Identify configuration, taskSpec and task-run-time information that lead to the production of the build but is currently missing in the provenance.
- Identify where in the provenance to host this missing information.

## Out-of-scope
- Completeness of complete build instructions using a **Pipeline Run**. We should be able to take a similar approach for provenance generated for Pipeline as well.
- A **Resolved Inputs** field for TaskRun where "resolved inputs" is a direct encoding of reproducibility (and verified during the build pod itself via the entrypointer). In the long term, it is useful to have reproducibility metadata built into pipelines so that the changes to the TaskRun will need to consider reproducibility and chains does not have to be constantly updated whenever there is a drift. This field will require its own TEP to spec-out the details and therefore it is currently out-of-scope.
- **Level of reproducibility** in the provenance: 
  - **Full** -- A user can rerun the exact steps with the exact inputs and get the exact results, with all <choose your favorite hash> signatures matching for inputs and artifacts. Until we have provenance that captures the full toolchain version stack -- possibly even down to the OS kernel version(?) -- we're going to be very hard-pressed to guarantee full reproducibility in the initial implementation.
  - **Partial** -- We can guarantee that a user can run the exact steps with the exact inputs -- but the output artifacts could change due to timestamps included in the output artifact or toolchain changes. The output artifact is functionally identical but the signature doesn't match.
- **Hermetic builds**
  - For this proposal, hermetic builds are out-of-scope. Hermetic build does not guarantee reproducibility (eg. If the build script links library1 or library2 depending on whether build process id or timestamp is a particular value then running the build again might not give the same result) but if a build is not hermetic then we cannot guarantee reproducibility. Tekton introduced hermetic builds in [TEP 0025](https://github.com/tektoncd/community/blob/main/teps/0025-hermekton.md). Since then, it has been an experimental feature. This feature needs to be pulled out of an experimental feature and [propagated to beta](https://github.com/tektoncd/pipeline/issues/3965https://github.com/tektoncd/pipeline/issues/3965) and beyond to unblock reproducible builds.
- **Complete list of system architecture** like host architecture (amd64 vs arm64), SELinux, container runtimes, and kubernetes version are out-of-scope.
- **Tekton system versioning** since there are a couple of separate efforts trying to tackle this (eg, [TEP-0041](https://github.com/tektoncd/community/blob/main/teps/0041-tekton-component-versioning.md), [tektoncd/pipeline#5303](https://github.com/tektoncd/pipeline/issues/5303)).

## Proposal
For the completeness of build instructions, we need to be able to extract enough information from the provenance to recreate the task run or pipeline run under the same set of configuration as was used when creating the build. The list below shows which fields are required in the provenance for re-creating the task run.
- [Task Specification](#task-specification)
- [Step Specification](#step-specification)
- [TaskRef](#taskref)
- [TaskRun Specification](#taskrun-specification)
- [Configuration feature flags](#configuration-feature-flags)
- [Materials](#materials)

This will allow us to create a provenance for a task run as [shown](#provenance-for-executed-taskrun).

### Task Specification
The table below provides the name and description of the API fields that the Task requires. In addition, it also lists if that information is required, not required, or provided by the provenance. If it is required, it also shows where the information should be provided. Looking at the table below and required [step](#step-specification) information, there are only a handful of fields that are not required for reproducibility. Instead of cherry-picking most of the fields, including the entire taskSpec in the buildConfig section of the provenance is likely the best way to go forward. Additionally, if we update the spec in the future, then chains will not have to be updated correspondingly. The work described in [issue](https://github.com/tektoncd/chains/issues/597) is meant to handle this.


| | **Metadata**      | | |
| ------ | ------------- | ----- | ----- |
| **Field Name**    | **Description** | **Not Required / Required / Provided by provenance** | **Insert in provenance** |
| name          | Name of the task | Required | |
| Spec          | | | |
| resources     | resources used by steps | Not Required (Deprecated) |  |
| description   | description of the task | Not Required |  |
| params        | parameters required by task | Provided |  |
| results       | results produced by the task | Required(Atleast name, type and  properties (in case of object)) | buildConfig |
| volumes       | volume mounted on the container | Required | buildConfig |
| workspaces    | workspace bindings used by the task | Required | buildConfig |
| steps         | Steps performed by the task | Provided |  |
| sidecars      | Sidecars running alongside tasks | Required | buildConfig |
| step template | Specifies a container configuration that will be used as the starting point for all of the Steps in your Task | Required | buildConfig |

### Step Specification

The table below provides the name and description of the API fields that the Step requires. In addition, it also lists if that information is required, not required, or provided by the provenance. If it is required, it also shows where the information should be provided. **Deprecated fields have not been included in the table below.**  Like in [Task Specification](#task-specification), almost all fields are either required or provided in the provenance. Therefore for the same reasons, we should include the entire spec in the generated provenance.


| | **Metadata**      | | |
| ------ | ------------- | ----- | ----- |
| **Field Name**    | **Description** | **Not Required / Required / Provided by provenance** | **Insert in provenance** |
| name             | Name of the step | Not Required | |
| image            | Image name for this step | Provided |  |
| command          | Entrypoint array | Provided |  |
| args             | Arguments to the entrypoint | Provided |  |
| working Dir      | Step’s working directory | Required | buildConfig |
| EnvFrom          | List of sources to populate env variables | Required | buildConfig |
| Env              | List of env variables to set in the container | Required | buildConfig |
| Resources        | Compute resources required by this step | Required | buildConfig |
| VolumeMounts     | Volumes to mount in the step’s filesystem | Required | buildConfig |
| VolumeDevices    | List of block devices to be used by the step | Required | buildConfig |
| ImagePullPolicy  | Image Pull Policy | Required | buildConfig |
| Security Context | security options the step should run with | Required | buildConfig |
| Script           | Contents of an executable file to execute | Provided |  |
| Timeout          | Time after which the step times out | Required | buildConfig |
| Workspaces       | list of workspaces from the task that the step wants exclusive access to | Required | buildConfig |
| OnError          | behavior of the container on error | Required | buildConfig |
| StdOut Config    | config of the stdout stream | Required | buildConfig |
| StdErr Config    | config of the stderr stream | Required | buildConfig |

### TaskRef

TaskRef is useful for references to existing tasks on the cluster or remote tasks (git, oci bundles and catalog). However, if users need to reproduce the build on a different cluster then those tasks are not guaranteed to be the same. Additionally, in the taskRun’s status, we already have access to the complete taskSpec of the referenced task. For this reason, we choose to store the taskSpec in the buildConfig in order to accurately reproduce the task run regardless of where the task was referenced. If the reference is made to a remote task (i.e. git, OCI bundles or catalog) then we also store the reference information (e.g. git url, commit-sha, etc.) in **invocation.configSource’s** URI, Digest and Entrypoint fields.

### TaskRun Specification

The table below provides the name and description of the API fields that the TaskRun requires. In addition, it also lists if that information is required, not required, or provided by the provenance. If it is required, it also shows where the information should be provided. Note that since task run provides information during runtime, most of the information is contained in the **invocation.Parameters** section of the provenance.


| | **Metadata**      | | |
| ------ | ------------- | ----- | ----- |
| **Field Name**    | **Description** | **Not Required / Required / Provided by provenance** | **Insert in provenance** |
| name| Name of the task run| Required (provide an audit trail)|  |
| | **Spec** | | |
| resources | resources used by task | Provided (can be extracted from steps/entrypoint) |  |
| service account name | name of the service account | Required | buildConfig |
| params | parameter values provided by taskrun | Provided |  |
| workspaces | workspaces used by the task | Required | buildConfig |
| pod template | | Required | buildConfig |
| Timeout | time in which a task should complete | Not Required (can probably use default?) |  |
| StepOverrides | Override Step configuration specified in a Task. Currently we can override compute resources. | Not Required |  |
| SidecarOverrides | Override Sidecar configuration specified in a Task. Currently we can override compute resources. | Not Required |  |
| ComputeResources | Configure compute resources required by the steps in the task. | Required (because this could also indicate a minimum amount of resources required for the task run.) | buildConfig |
| [TaskSpec](#task-specification) | Specification of the resolved task | See [spec](#task-specification) | buildConfig |
| [TaskRef](#taskref)  | Details of the referenced task | Not Required (Since we save the complete TaskSpec even that of a remote task) |  |
| | **Status** | | |
| Task Results | Results produced by the task run | Not Required | buildConfig |


### Configuration Feature Flags

The feature flags that a user/operator specified during installation of Tekton pipelines that lead to the build are also required. These can be added to the **invocation.Environment** section of the [provenance](#provenance-for-executed-taskrun). The feature flags should be fetched by the task run reconciler and embedded in the **task run status** so that chains can access it easily.

### Materials
To capture [predicate.materials](https://slsa.dev/provenance/v0.2#materials) that were used during the build, we can set the source information in the resolution request CRD (see issue [#5522](https://github.com/tektoncd/pipeline/issues/5522)). If no materials can be parsed from the parameters/results of the task run then we mark **metadata.completeness.materials** as false, making the build non-reproducible. If the materials are captured in the provenance but the build was not running hermetically, we will still mark the completeness as false because we cannot guarantee material completeness unless the build was running hermetically.

### Provenance for executed TaskRun

The generated provenance for the executed** task run** should contain the following information:

```
  buildType: uri # contains the schema for invocation and buildConfig. We need to host this somewhere and maintain it of course.
  invocation:
    configSource:
      URI: str # e.g. "git+https://github.com/test/tekton-test.git"
      Digest:
        sha256 : “123fdf35b4e7b1a56a84b2796aab2827edd65c25” # e.g. could be the commit sha 
      Entrypoint: “task.yaml” # the yaml config to run
    parameters:
      [taskRun](https://github.com/tektoncd/pipeline/blob/b301d88cf4af3301cfff40e3df6d85ad3848df0d/pkg/apis/pipeline/v1beta1/taskrun_types.go#L38-L86):
        name:
        serviceAccountName:
        computeResources:
        workspaces:
        podTemplate:
        taskRunResults:
        params:
        sidecarOverrides:
        stepOverrides:
        timeout:
    environment:
      tekton-config-feature-flags: # feature flags that led to the build
        - enable-alpha-api: “alpha”
        - feature-foo: “bar”
        ...
  buildConfig:
    taskSpec:
      steps:
      sidecars:
      stepTemplate:
      volumes:
      workspaces:
      results:
  metadata: 
    reproducible: bool 
    completeness:
      parameters: bool
      environment: bool
      materials: bool
  materials: # provided by users as task run parameters or produced by the task run as results
    - uri:
      digest:
   ...
```
